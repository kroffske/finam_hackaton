# üîÑ Cross-Validation –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤

> **–¶–µ–ª—å**: –ù–∞–¥–µ–∂–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–µ–π –±–µ–∑ data leakage –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–º–∏—Å—è —Ç–∞—Ä–≥–µ—Ç–∞–º–∏ t+20

---

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –æ–±—ã—á–Ω—ã–π K-Fold –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

### –ü–æ—á–µ–º—É –æ–±—ã—á–Ω–∞—è –∫—Ä–æ—Å—Å–≤–∞–ª–∏–¥–∞—Ü–∏—è –æ–ø–∞—Å–Ω–∞?

**–û–±—ã—á–Ω—ã–π K-Fold:**
```
Fold 1: [Train: samples 1-800  ] [Test: samples 801-1000]
Fold 2: [Train: samples 1-600  ] [Test: samples 601-800 ]
         ‚Üë                              ‚Üë
         –ü–µ—Ä–µ–º–µ—à–∞–Ω—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Üí DATA LEAKAGE!
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. ‚ùå **–ù–∞—Ä—É—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞** ‚Äî –º–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç –±—É–¥—É—â–µ–µ
2. ‚ùå **Overlap –≤ —Ç–∞—Ä–≥–µ—Ç–∞—Ö** ‚Äî `target_return_20d` –≤ –¥–µ–Ω—å t –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–µ–Ω—É –∏–∑ –¥–Ω—è t+20
3. ‚ùå **–ù–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞** ‚Äî –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –º—ã –ù–ï –∑–Ω–∞–µ–º –±—É–¥—É—â–µ–µ

### –ü—Ä–∏–º–µ—Ä data leakage

```python
# –î–µ–Ω—å 980 (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤ train):
date_980 = '2025-01-06'
close_980 = 100.0
close_1000 = 105.0  # –ß–µ—Ä–µ–∑ 20 —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π
target_return_20d = (105.0 / 100.0) - 1 = 0.05  # +5%

# –î–µ–Ω—å 1001 (–ø–µ—Ä–≤—ã–π –≤ test):
date_1001 = '2025-02-04'

# –£–¢–ï–ß–ö–ê: target_return_20d –¥–ª—è –¥–Ω—è 980 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–µ–Ω—É –¥–Ω—è 1000,
# –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –í–ù–£–¢–†–ò test –ø–µ—Ä–∏–æ–¥–∞!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –º–æ–¥–µ–ª—å –ø–µ—Ä–µ–æ–±—É—á–∞–µ—Ç—Å—è, –º–µ—Ç—Ä–∏–∫–∏ –∑–∞–≤—ã—à–µ–Ω—ã, –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö—É–∂–µ.

---

## üìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö: –±–∏—Ä–∂–µ–≤—ã–µ –¥–Ω–∏ –∏ –ø—Ä–æ–ø—É—Å–∫–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–∫—Ç—ã:**
- **–ü–µ—Ä–∏–æ–¥**: 2020-06-19 –¥–æ 2025-04-15
- **–í—Å–µ–≥–æ**: 1,761 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π
- **–¢–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π**: 1,217 (69% –æ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö)
- **–¢–∏–∫–µ—Ä–æ–≤**: 19

### –¢–∏–ø—ã –ø—Ä–æ–ø—É—Å–∫–æ–≤

#### 1. –í—ã—Ö–æ–¥–Ω—ã–µ (—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ)
```
2020-06-19 (–ü—Ç) ‚Üí 2020-06-22 (–ü–Ω): 3 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω—è
2020-06-26 (–ü—Ç) ‚Üí 2020-06-29 (–ü–Ω): 3 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω—è
```

**–ß–∞—Å—Ç–æ—Ç–∞**: –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é
**–§–æ—Ä–º—É–ª–∞**: –ø—Ç ‚Üí –ø–Ω = 3 –¥–Ω—è (—Å–±, –≤—Å)

#### 2. –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ (–Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ)
```
2020-12-30 ‚Üí 2021-01-04: 5 –¥–Ω–µ–π  (–ù–æ–≤—ã–π –≥–æ–¥)
2022-04-29 ‚Üí 2022-05-04: 5 –¥–Ω–µ–π  (–ú–∞–π—Å–∫–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏)
2024-03-07 ‚Üí 2024-03-11: 4 –¥–Ω—è   (8 –º–∞—Ä—Ç–∞)
```

**–ß–∞—Å—Ç–æ—Ç–∞**: ~10 —Ä–∞–∑ –≤ –≥–æ–¥
**–†–∞–∑–º–µ—Ä**: 4-5 –¥–Ω–µ–π

#### 3. –ê–Ω–æ–º–∞–ª–∏–∏ (—Ä–µ–¥–∫–∏–µ)
```
2022-02-25 ‚Üí 2022-03-24: 27 –¥–Ω–µ–π  (–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤)
```

**–ü—Ä–∏—á–∏–Ω–∞**: –ì–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è (–∑–∞–∫—Ä—ã—Ç–∏–µ –±–∏—Ä–∂–∏ –≤ —Ñ–µ–≤—Ä–∞–ª–µ-–º–∞—Ä—Ç–µ 2022)

### –ü—Ä–æ–ø—É—Å–∫–∏ –ø–æ —Ç–∏–∫–µ—Ä–∞–º

| Ticker | –ü–æ–ª–Ω–æ—Ç–∞ | Missing days | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|--------|---------|--------------|------------|
| SBER   | 100%    | 0            | –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
| GAZP   | 100%    | 0            | –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
| T      | 98.19%  | 22           | –°–∞–º—ã–µ –Ω–µ–ø–æ–ª–Ω—ã–µ |
| GMKN   | 99.67%  | 4            | –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤ |
| SIBN   | 99.51%  | 6            | –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤ |

**–í—ã–≤–æ–¥**: –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ç–∏–∫–µ—Ä–æ–≤ –∏–º–µ—é—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –µ—Å—Ç—å 6 —Ç–∏–∫–µ—Ä–æ–≤ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏.

---

## üìÖ –ß—Ç–æ —Ç–∞–∫–æ–µ t+20 –≤ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω—è—Ö?

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**t+20** = 20 **—Ç–æ—Ä–≥–æ–≤—ã—Ö** –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥ (–ù–ï –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö!)

```python
# –¢–æ—Ä–≥–æ–≤—ã–µ –¥–Ω–∏ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏):
t = 2024-01-15 (Mon)
t+1 = 2024-01-16 (Tue)
t+2 = 2024-01-17 (Wed)
t+3 = 2024-01-18 (Thu)
t+4 = 2024-01-19 (Fri)
# –í—ã—Ö–æ–¥–Ω—ã–µ: 2024-01-20 (Sat), 2024-01-21 (Sun) - –ü–†–û–ü–£–°–ö–ê–ï–ú
t+5 = 2024-01-22 (Mon)
...
t+20 = 2024-02-12 (Mon)  # –ü—Ä–∏–º–µ—Ä–Ω–æ 28 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π
```

### –§–æ—Ä–º—É–ª–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

**20 —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π ‚âà 28-30 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π**

```
–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏ = –¢–æ—Ä–≥–æ–≤—ã–µ –¥–Ω–∏ √ó (7 / 5) √ó (1 + –ø—Ä–∞–∑–¥–Ω–∏–∫–∏)
                ‚âà 20 √ó 1.4 √ó 1.02
                ‚âà 28.6 –¥–Ω–µ–π
```

**–î–∏–∞–ø–∞–∑–æ–Ω**: –æ—Ç 28 –¥–Ω–µ–π (–æ–±—ã—á–Ω—ã–µ –Ω–µ–¥–µ–ª–∏) –¥–æ 35 –¥–Ω–µ–π (—Å –¥–ª–∏–Ω–Ω—ã–º–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞–º–∏)

### –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å t+20?

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–∞—Ç
2. –ù–∞–π—Ç–∏ –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
3. –í–∑—è—Ç—å –¥–∞—Ç—É —Å –∏–Ω–¥–µ–∫—Å–æ–º `current_index + 20`

```python
trading_dates = sorted(df['begin'].dt.date.unique())
# ['2020-06-19', '2020-06-22', '2020-06-23', ..., '2025-04-15']

current_date = datetime.date(2024, 1, 15)
current_idx = trading_dates.index(current_date)  # –ù–∞–ø—Ä–∏–º–µ—Ä, 892

t_plus_20 = trading_dates[current_idx + 20]  # trading_dates[912]
# ‚Üí 2024-02-12
```

### –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–∞

| t (–Ω–∞—á–∞–ª–æ) | t+20 (—Ç–æ—Ä–≥–æ–≤—ã–π) | –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------------|-----------------|------------------|------------|
| 2020-06-19 | 2020-07-21      | 32               | –í–∫–ª—é—á–∞–µ—Ç –≤—ã—Ö–æ–¥–Ω—ã–µ |
| 2020-09-01 | 2020-09-29      | 28               | –û–±—ã—á–Ω—ã–π –º–µ—Å—è—Ü |
| 2020-11-11 | 2020-12-09      | 28               | –ë–µ–∑ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ |
| 2024-01-15 | 2024-02-12      | 28               | –û–±—ã—á–Ω—ã–π –ø–µ—Ä–∏–æ–¥ |
| 2024-03-01 | 2024-04-01      | 31               | –í–∫–ª—é—á–∞–µ—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫ 8 –º–∞—Ä—Ç–∞ |

**–í—ã–≤–æ–¥**: –í —Å—Ä–µ–¥–Ω–µ–º 28-29 –¥–Ω–µ–π, –Ω–æ –º–æ–∂–µ—Ç –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ—Ç 28 –¥–æ 35 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤.

---

## üîß –†–µ—à–µ–Ω–∏–µ: Rolling Window CV —Å gap

### –ü—Ä–∏–Ω—Ü–∏–ø

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:** –ú–µ–∂–¥—É train –∏ test –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–∑–∞–∑–æ—Ä (gap) = 21 —Ç–æ—Ä–≥–æ–≤—ã–π –¥–µ–Ω—å**

```
[‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Train ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ] [‚îÄ‚îÄ Gap ‚îÄ‚îÄ] [‚îÄ‚îÄ Test ‚îÄ‚îÄ]
    1,000 —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π         21 –¥–Ω–µ–π     60 –¥–Ω–µ–π
                              ‚Üë
                        –ó–∞—â–∏—Ç–∞ –æ—Ç leakage!
```

**–ü–æ—á–µ–º—É 21?**
- 20 –¥–Ω–µ–π –¥–ª—è `target_return_20d`
- +1 –¥–µ–Ω—å safety margin
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç: –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–∞—Ä–≥–µ—Ç –≤ train –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å test –¥–∞–Ω–Ω—ã–º–∏

### –°—Ö–µ–º–∞ —Ä–∞–∑–±–∏–µ–Ω–∏—è (5 —Ñ–æ–ª–¥–æ–≤)

–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π: **1,217**

```
Total:    [‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê 1,217 –¥–Ω–µ–π ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê]

Fold 1:   [‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Train ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê][Gap][Test 60]
          Day 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Day 1115  1136  1157-1217

Fold 2:   [‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Train ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê][Gap][Test 60]
          Day 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Day 1055  1076  1097-1157

Fold 3:   [‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Train ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê][Gap][Test 60]
          Day 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Day 995   1016  1037-1097

Fold 4:   [‚ïê‚ïê‚ïê Train ‚ïê‚ïê‚ïê‚ïê][Gap][Test 60]
          Day 1 ‚îÄ‚îÄ‚Üí Day 935   956   977-1037

Fold 5:   [‚ïê Train ‚ïê][Gap][Test 60]
          Day 1 ‚Üí Day 875   896   917-977
```

### –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —Ä–∞–∑–±–∏–µ–Ω–∏—è

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `n_splits = 5` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ–ª–¥–æ–≤
- `test_size = 60` ‚Äî —Ä–∞–∑–º–µ—Ä test –≤ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω—è—Ö
- `gap = 21` ‚Äî –∑–∞–∑–æ—Ä –º–µ–∂–¥—É train –∏ test

**–§–æ—Ä–º—É–ª–∞:**
```python
total_days = 1217
test_size = 60
gap = 21

for fold_idx in range(n_splits):
    # –ò–Ω–¥–µ–∫—Å—ã test
    test_end = total_days - fold_idx * test_size
    test_start = test_end - test_size + 1

    # –ò–Ω–¥–µ–∫—Å—ã train (—Å —É—á–µ—Ç–æ–º gap)
    train_end = test_start - gap - 1
    train_start = 0

    print(f"Fold {fold_idx+1}:")
    print(f"  Train: day {train_start} to {train_end}")
    print(f"  Gap:   {gap} days")
    print(f"  Test:  day {test_start} to {test_end}")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Fold 1: Train 1-1136 (1136 –¥–Ω–µ–π) | Gap 21 | Test 1157-1217 (60 –¥–Ω–µ–π)
Fold 2: Train 1-1076 (1076 –¥–Ω–µ–π) | Gap 21 | Test 1097-1157 (60 –¥–Ω–µ–π)
Fold 3: Train 1-1016 (1016 –¥–Ω–µ–π) | Gap 21 | Test 1037-1097 (60 –¥–Ω–µ–π)
Fold 4: Train 1-956  (956 –¥–Ω–µ–π)  | Gap 21 | Test 977-1037  (60 –¥–Ω–µ–π)
Fold 5: Train 1-896  (896 –¥–Ω–µ–π)  | Gap 21 | Test 917-977   (60 –¥–Ω–µ–π)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ data leakage

**–î–ª—è –∫–∞–∂–¥–æ–≥–æ fold:**

```python
# –ü—Ä–∏–º–µ—Ä: Fold 1
train_end = day 1136 (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2025-01-06)
test_start = day 1157 (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2025-02-05)

# –ü—Ä–æ–≤–µ—Ä–∫–∞:
# 1. –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å train (1136) –∏–º–µ–µ—Ç target_20d –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π –∏–∑ –¥–Ω—è 1156
#    –î–µ–Ω—å 1156 = 2025-02-04 (–∑–∞ 1 –¥–µ–Ω—å –¥–æ test_start)
# 2. –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å test (1157) = 2025-02-05
# 3. –ù–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è ‚úì

gap_actual = test_start - train_end - 1 = 1157 - 1136 - 1 = 20
# –ù–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º gap=21 –¥–ª—è safety ‚Üí –µ—â–µ –ª—É—á—à–µ!
```

**–í—ã–≤–æ–¥:** –° gap=21 –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ù–ï–¢ —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

---

## üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: src/finam/cv.py

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### 1. `get_trading_dates(df)` ‚Äî –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π
```python
def get_trading_dates(df: pd.DataFrame) -> list[datetime.date]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–∞—Ç

    Args:
        df: DataFrame —Å –∫–æ–ª–æ–Ω–∫–æ–π 'begin' (datetime)

    Returns:
        –°–ø–∏—Å–æ–∫ –¥–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ datetime.date, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é

    Example:
        >>> dates = get_trading_dates(train_df)
        >>> dates[:5]
        [datetime.date(2020, 6, 19),
         datetime.date(2020, 6, 22),
         datetime.date(2020, 6, 23), ...]
    """
```

#### 2. `compute_t_plus_n(df, date, n)` ‚Äî –í—ã—á–∏—Å–ª–∏—Ç—å t+N
```python
def compute_t_plus_n(
    df: pd.DataFrame,
    date: datetime.date,
    n: int = 20
) -> datetime.date:
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç t+N –≤ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω—è—Ö

    Args:
        df: DataFrame —Å —Ç–æ—Ä–≥–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        date: –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
        n: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥ (default: 20)

    Returns:
        –î–∞—Ç–∞ —á–µ—Ä–µ–∑ N —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π

    Raises:
        ValueError: –µ—Å–ª–∏ date –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ t+n –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –¥–∞–Ω–Ω—ã—Ö

    Example:
        >>> t_plus_20 = compute_t_plus_n(df, datetime.date(2024, 1, 15), n=20)
        >>> t_plus_20
        datetime.date(2024, 2, 12)  # –ü—Ä–∏–º–µ—Ä–Ω–æ 28 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π
    """
```

#### 3. `rolling_window_cv(...)` ‚Äî –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è CV
```python
def rolling_window_cv(
    df: pd.DataFrame,
    n_splits: int = 5,
    test_size: int = 60,
    gap: int = 21,
    min_train_size: int = 200
) -> Iterator[tuple[pd.DataFrame, pd.DataFrame]]:
    """
    Rolling window cross-validation —Å gap –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤

    Args:
        df: DataFrame —Å —Ç–æ—Ä–≥–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∫–æ–ª–æ–Ω–∫—É 'begin')
        n_splits: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ–ª–¥–æ–≤ (default: 5)
        test_size: –†–∞–∑–º–µ—Ä test –≤ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω—è—Ö (default: 60)
        gap: –ó–∞–∑–æ—Ä –º–µ–∂–¥—É train –∏ test –≤ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω—è—Ö (default: 21)
        min_train_size: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä train (default: 200)

    Yields:
        (train_df, test_df) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ–ª–¥–∞

    Example:
        >>> for fold_idx, (train, test) in enumerate(rolling_window_cv(df)):
        ...     print(f"Fold {fold_idx}: train={len(train)}, test={len(test)}")
        ...     model.fit(train)
        ...     metrics = model.evaluate(test)
    """
```

#### 4. `evaluate_with_cv(...)` ‚Äî –û—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–∏
```python
def evaluate_with_cv(
    model,
    df: pd.DataFrame,
    feature_cols: list[str],
    n_splits: int = 5,
    verbose: bool = True,
    **cv_kwargs
) -> dict[str, list[float]]:
    """
    –û—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–∏ —Å –ø–æ–º–æ—â—å—é –∫—Ä–æ—Å—Å–≤–∞–ª–∏–¥–∞—Ü–∏–∏

    Args:
        model: –û–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏ —Å –º–µ—Ç–æ–¥–∞–º–∏ fit() –∏ predict()
        df: DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏
        feature_cols: –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
        n_splits: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ–ª–¥–æ–≤
        verbose: –ü–µ—á–∞—Ç–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        **cv_kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è rolling_window_cv()

    Returns:
        Dict —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ–ª–¥–∞:
        {
            'mae_1d': [fold1, fold2, fold3, fold4, fold5],
            'mae_20d': [...],
            'brier_1d': [...],
            'brier_20d': [...],
            'da_1d': [...],
            'da_20d': [...],
            'score_1d': [...],
            'score_20d': [...],
            'score_total': [...]
        }

    Example:
        >>> from finam.model import LightGBMModel
        >>> model = LightGBMModel()
        >>> cv_results = evaluate_with_cv(
        ...     model, train_df, feature_cols,
        ...     n_splits=5, test_size=60, gap=21
        ... )
        >>> print(f"Mean MAE 1d: {np.mean(cv_results['mae_1d']):.4f}")
        >>> print(f"Std MAE 1d:  {np.std(cv_results['mae_1d']):.4f}")
    """
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
from finam.cv import rolling_window_cv, evaluate_with_cv
from finam.model import LightGBMModel
import pandas as pd

# 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
train_df = pd.read_parquet('data/preprocessed/train.parquet')

# 2. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
feature_cols = [col for col in train_df.columns
                if col not in ['ticker', 'begin', 'open', 'high', 'low',
                               'close', 'volume', 'adj_close']
                and not col.startswith('target_')]

# 3. –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å
model = LightGBMModel(
    n_estimators=300,
    learning_rate=0.05,
    max_depth=7
)

# 4. –û—Ü–µ–Ω–∏—Ç—å —Å –ø–æ–º–æ—â—å—é CV
cv_results = evaluate_with_cv(
    model=model,
    df=train_df,
    feature_cols=feature_cols,
    n_splits=5,
    test_size=60,
    gap=21,
    verbose=True
)

# 5. –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
import numpy as np

print("=" * 60)
print("CROSS-VALIDATION RESULTS")
print("=" * 60)

for metric_name in ['mae_1d', 'mae_20d', 'score_total']:
    values = cv_results[metric_name]
    print(f"{metric_name:15s}: {np.mean(values):.4f} ¬± {np.std(values):.4f}")
    print(f"                   Range: [{np.min(values):.4f}, {np.max(values):.4f}]")

# 6. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
import json
with open('cv_results.json', 'w') as f:
    json.dump({k: [float(v) for v in vals] for k, vals in cv_results.items()}, f, indent=2)
```

**–í—ã–≤–æ–¥:**
```
============================================================
CROSS-VALIDATION RESULTS
============================================================
mae_1d         : 0.0172 ¬± 0.0013
                   Range: [0.0156, 0.0188]
mae_20d        : 0.0895 ¬± 0.0067
                   Range: [0.0821, 0.0971]
score_total    : 0.1055 ¬± 0.0089
                   Range: [0.0942, 0.1167]
```

---

## üìê –í—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ CV

### Test size (—Ä–∞–∑–º–µ—Ä test)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: 60 —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π**

**–ü–æ—á–µ–º—É?**
- 60 –¥–Ω–µ–π ‚âà 3 –º–µ—Å—è—Ü–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
- –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–æ–π –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ–π –æ—Ü–µ–Ω–∫–∏
- –ù–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (—á—Ç–æ–±—ã –±—ã–ª–æ –º–µ—Å—Ç–æ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ–ª–¥–æ–≤)
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–º —Ü–∏–∫–ª–∞–º –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ (–∫–≤–∞—Ä—Ç–∞–ª)

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- **40 –¥–Ω–µ–π** (2 –º–µ—Å—è—Ü–∞) ‚Äî –¥–ª—è –±–æ–ª–µ–µ —á–∞—Å—Ç—ã—Ö —Ñ–æ–ª–¥–æ–≤
- **60 –¥–Ω–µ–π** (3 –º–µ—Å—è—Ü–∞) ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è ‚úì
- **80 –¥–Ω–µ–π** (4 –º–µ—Å—è—Ü–∞) ‚Äî –¥–ª—è –±–æ–ª–µ–µ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –æ—Ü–µ–Ω–∫–∏

### Gap (–∑–∞–∑–æ—Ä)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: 21 —Ç–æ—Ä–≥–æ–≤—ã–π –¥–µ–Ω—å**

**–ü–æ—á–µ–º—É?**
- 20 –¥–Ω–µ–π –¥–ª—è `target_return_20d`
- +1 –¥–µ–Ω—å safety margin
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ data leakage

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- **20 –¥–Ω–µ–π** ‚Äî –º–∏–Ω–∏–º—É–º (—Ä–æ–≤–Ω–æ –¥–ª—è t+20)
- **21 –¥–µ–Ω—å** ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è ‚úì
- **25 –¥–Ω–µ–π** ‚Äî extra safety (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–º–Ω–µ–Ω–∏—è)

### Number of splits (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ–ª–¥–æ–≤)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: 5 —Ñ–æ–ª–¥–æ–≤**

**–ü–æ—á–µ–º—É?**
- –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É computational cost –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é
- –ö–∞–∂–¥—ã–π fold —Ç—Ä–µ–Ω–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 800-1100 –¥–Ω—è—Ö (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
- Standard –≤ ML (5-fold –∏–ª–∏ 10-fold)

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- **3 —Ñ–æ–ª–¥–∞** ‚Äî –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
- **5 —Ñ–æ–ª–¥–æ–≤** ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è ‚úì
- **10 —Ñ–æ–ª–¥–æ–≤** ‚Äî –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ, –Ω–æ –¥–æ–ª—å—à–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è

### –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞

```python
total_days = 1217  # –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–Ω–µ–π

# –¢—Ä–µ–±—É–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è n_splits —Ñ–æ–ª–¥–æ–≤:
required_days = n_splits * test_size + (n_splits - 1) * gap + min_train_size

# –ü—Ä–∏–º–µ—Ä –¥–ª—è n_splits=5:
required = 5 * 60 + 4 * 21 + 200 = 300 + 84 + 200 = 584 –¥–Ω–µ–π

# –î–æ—Å—Ç—É–ø–Ω–æ: 1217 > 584 ‚úì
# –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 5 —Ñ–æ–ª–¥–æ–≤!
```

---

## ‚ö†Ô∏è –û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. Missing ticker data

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–∏–∫–µ—Ä—ã (T, GMKN, SIBN) –∏–º–µ—é—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã

**–†–µ—à–µ–Ω–∏—è:**

**–í–∞—Ä–∏–∞–Ω—Ç A: Drop incomplete tickers**
```python
# –£–±—Ä–∞—Ç—å —Ç–∏–∫–µ—Ä—ã —Å >1% –ø—Ä–æ–ø—É—Å–∫–æ–≤
completeness = df.groupby('ticker')['begin'].nunique() / len(trading_dates)
complete_tickers = completeness[completeness >= 0.99].index
df_filtered = df[df['ticker'].isin(complete_tickers)]
```

**–í–∞—Ä–∏–∞–Ω—Ç B: Forward-fill missing dates**
```python
# –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∏–∑–≤–µ—Å—Ç–Ω–æ–π —Ü–µ–Ω–æ–π
df = df.set_index(['ticker', 'begin']).sort_index()
df = df.groupby('ticker').fillna(method='ffill')
```

**–í–∞—Ä–∏–∞–Ω—Ç C: Skip missing dates (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è CV)**
```python
# –ü—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞—Ç—ã
# CV –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

### 2. –ü–µ—Ä–∏–æ–¥ –∑–∞–∫—Ä—ã—Ç–∏—è –±–∏—Ä–∂–∏ (2022-02-25 ‚Üí 2022-03-24)

**–ü—Ä–æ–±–ª–µ–º–∞:** 27-–¥–Ω–µ–≤–Ω—ã–π gap –Ω–∞—Ä—É—à–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏—è:**

**–í–∞—Ä–∏–∞–Ω—Ç A: Exclude period**
```python
# –£–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
df = df[(df['begin'] < '2022-02-25') | (df['begin'] > '2022-03-24')]
```

**–í–∞—Ä–∏–∞–Ω—Ç B: Treat as a regime change**
```python
# –î–æ–±–∞–≤–∏—Ç—å dummy variable –¥–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
df['is_crisis_period'] = (df['begin'] >= '2022-02-25') & (df['begin'] <= '2022-03-24')
```

**–í–∞—Ä–∏–∞–Ω—Ç C: Keep as is (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
- –ú–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–æ–±–∞—Å—Ç–Ω–æ–π –∫ —Ç–∞–∫–∏–º —Å–æ–±—ã—Ç–∏—è–º
- –í —Ä–µ–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–µ —Ç–∞–∫–æ–µ –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å—Å—è
- –ü—Ä–æ—Å—Ç–æ –ø–æ–º–Ω–∏—Ç—å —á—Ç–æ –º–µ—Ç—Ä–∏–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Ö—É–∂–µ –Ω–∞ —ç—Ç–æ–º –ø–µ—Ä–∏–æ–¥–µ

### 3. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏ –±–µ–∑ —Ç–∞—Ä–≥–µ—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –¥–Ω–µ–π –∫–∞–∂–¥–æ–≥–æ —Ç–∏–∫–µ—Ä–∞ –Ω–µ –∏–º–µ—é—Ç `target_return_20d`

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ `scripts/1_prepare_data.py`:
```python
# –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å NaN –≤ —Ç–∞—Ä–≥–µ—Ç–∞—Ö
df.dropna(subset=['target_return_1d', 'target_return_20d'], inplace=True)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í preprocessed –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –Ω–µ—Ç —Å—Ç—Ä–æ–∫ –±–µ–∑ —Ç–∞—Ä–≥–µ—Ç–æ–≤ ‚úì

---

## üìä –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ CV

### –ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç –º–µ—Ç—Ä–∏–∫–∏?

**Mean (—Å—Ä–µ–¥–Ω–µ–µ)** ‚Äî —Å—Ä–µ–¥–Ω–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–∞—Ö
```python
mean_mae = np.mean(cv_results['mae_1d'])
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∏–ø–∏—á–Ω—É—é –æ—à–∏–±–∫—É –º–æ–¥–µ–ª–∏
```

**Std (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ)** ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏
```python
std_mae = np.std(cv_results['mae_1d'])
# –ú–∞–ª–µ–Ω—å–∫–æ–µ std = –º–æ–¥–µ–ª—å —Å—Ç–∞–±–∏–ª—å–Ω–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–∞—Ö ‚úì
# –ë–æ–ª—å—à–æ–µ std = –º–æ–¥–µ–ª—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞, –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∞ ‚úó
```

**Range (–¥–∏–∞–ø–∞–∑–æ–Ω)** ‚Äî —Ä–∞–∑–±—Ä–æ—Å –∫–∞—á–µ—Å—Ç–≤–∞
```python
min_mae = np.min(cv_results['mae_1d'])
max_mae = np.max(cv_results['mae_1d'])
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ö—É–¥—à–∏–π/–ª—É—á—à–∏–π —Ñ–æ–ª–¥
```

### –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏

```
MAE 1d: 0.0172 ¬± 0.0013  Range: [0.0156, 0.0188]
        ‚Üë       ‚Üë                 ‚Üë       ‚Üë
      –°—Ä–µ–¥–Ω–µ–µ  Std              Min     Max
```

**–í—ã–≤–æ–¥:**
- ‚úÖ –°—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: 1.72% (—Ö–æ—Ä–æ—à–æ!)
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: ¬±0.13% (–æ—á–µ–Ω—å —Å—Ç–∞–±–∏–ª—å–Ω–∞!)
- ‚úÖ –•—É–¥—à–∏–π —Ñ–æ–ª–¥: 1.88% (–ø—Ä–∏–µ–º–ª–µ–º–æ)
- ‚úÖ –õ—É—á—à–∏–π —Ñ–æ–ª–¥: 1.56% (–æ—Ç–ª–∏—á–Ω–æ)

### Red flags (—Ç—Ä–µ–≤–æ–∂–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏)

**üö© –ë–æ–ª—å—à–æ–π std:**
```
MAE 1d: 0.0172 ¬± 0.0045  Range: [0.0120, 0.0250]
                  ‚Üë‚Üë‚Üë‚Üë
            –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! (26% –æ—Ç mean)
```
**–ü—Ä–∏—á–∏–Ω—ã:**
- –ú–æ–¥–µ–ª—å –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∞
- –°–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–∞—è –º–æ–¥–µ–ª—å
- –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏

**–†–µ—à–µ–Ω–∏–µ:** –£–ø—Ä–æ—Å—Ç–∏—Ç—å –º–æ–¥–µ–ª—å, –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—é

**üö© –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ train vs CV:**
```
Train MAE: 0.010  (–æ—Ç–ª–∏—á–Ω–æ!)
CV MAE:    0.025  (–ø–ª–æ—Ö–æ!)
           ‚Üë‚Üë‚Üë‚Üë
      –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ!
```

**–†–µ—à–µ–Ω–∏–µ:** –£–º–µ–Ω—å—à–∏—Ç—å complexity –º–æ–¥–µ–ª–∏

---

## üéØ Best Practices

### 1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ CV –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π
```python
# ‚úì –ü–†–ê–í–ò–õ–¨–ù–û:
cv_results = evaluate_with_cv(model, train_df, feature_cols)
if np.mean(cv_results['score_total']) > threshold:
    # –û–±—É—á–∏—Ç—å –Ω–∞ –≤—Å–µ—Ö train –¥–∞–Ω–Ω—ã—Ö
    model.fit(train_df, feature_cols)
    # –û—Ü–µ–Ω–∏—Ç—å –Ω–∞ val/test
    test_metrics = model.evaluate(test_df)

# ‚úó –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
model.fit(train_df, feature_cols)  # –°—Ä–∞–∑—É –æ–±—É—á–∏–ª–∏ –Ω–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
test_metrics = model.evaluate(test_df)  # –ú–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≤—ã—à–µ–Ω–æ!
```

### 2. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
```python
# –ï—Å–ª–∏ std > 30% –æ—Ç mean ‚Üí –º–æ–¥–µ–ª—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞
cv_results = evaluate_with_cv(model, train_df, feature_cols)
stability_ratio = np.std(cv_results['mae_1d']) / np.mean(cv_results['mae_1d'])

if stability_ratio > 0.3:
    print("‚ö†Ô∏è WARNING: Model is unstable!")
    print("   Consider: reduce model complexity, add regularization")
```

### 3. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã CV
```python
# –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å CV –º–µ—Ç—Ä–∏–∫–∏
import json

cv_summary = {
    'experiment_name': exp_name,
    'cv_params': {'n_splits': 5, 'test_size': 60, 'gap': 21},
    'metrics': {
        'mae_1d_mean': float(np.mean(cv_results['mae_1d'])),
        'mae_1d_std': float(np.std(cv_results['mae_1d'])),
        # ... –¥—Ä—É–≥–∏–µ –º–µ—Ç—Ä–∏–∫–∏
    },
    'fold_results': cv_results  # –ü–æ–ª–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö —Ñ–æ–ª–¥–æ–≤
}

with open(f'outputs/{exp_name}/cv_results.json', 'w') as f:
    json.dump(cv_summary, f, indent=2)
```

### 4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CV –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
```python
# Grid search —Å CV
best_score = -np.inf
best_params = None

for n_estimators in [100, 300, 500]:
    for learning_rate in [0.01, 0.05, 0.1]:
        model = LightGBMModel(n_estimators=n_estimators, learning_rate=learning_rate)
        cv_results = evaluate_with_cv(model, train_df, feature_cols)
        score = np.mean(cv_results['score_total'])

        if score > best_score:
            best_score = score
            best_params = {'n_estimators': n_estimators, 'learning_rate': learning_rate}

print(f"Best params: {best_params}")
```

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **[docs/METRICS.md](METRICS.md)** ‚Äî –û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ MAE, Brier, DA
- **[docs/evaluation.md](evaluation.md)** ‚Äî –ú–µ—Ç–æ–¥–∏–∫–∞ –æ—Ü–µ–Ω–∫–∏ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è
- **[CLAUDE.md](../CLAUDE.md)** ‚Äî Guidelines –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **[README.md](../README.md)** ‚Äî –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –∏ workflow

---

## üí° Takeaways

1. ‚úÖ **Gap = 21 –¥–µ–Ω—å** –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è t+20 —Ç–∞—Ä–≥–µ—Ç–æ–≤
2. ‚úÖ **Test size = 60 –¥–Ω–µ–π** –æ–ø—Ç–∏–º–∞–ª–µ–Ω –¥–ª—è –±–∞–ª–∞–Ω—Å–∞
3. ‚úÖ **5 —Ñ–æ–ª–¥–æ–≤** –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
4. ‚úÖ **–¢–æ—Ä–≥–æ–≤—ã–µ –¥–Ω–∏ ‚â† –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏** (20 —Ç–æ—Ä–≥–æ–≤—ã—Ö ‚âà 28 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö)
5. ‚úÖ **Std < 30% –æ—Ç mean** ‚Üí –º–æ–¥–µ–ª—å —Å—Ç–∞–±–∏–ª—å–Ω–∞
6. ‚úÖ **–í—Å–µ–≥–¥–∞ CV –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π** –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è

**–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã —Ç—Ä–µ–±—É—é—Ç gap –º–µ–∂–¥—É train –∏ test!
